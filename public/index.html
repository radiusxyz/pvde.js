<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>PVDE in wasm</title>
  </head>

  <body>
    <script type="module">
      import { pvde, skde } from "../src/index.js";
      const {
        fetchTimeLockPuzzleZkpParam,
        fetchTimeLockPuzzleProvingKey,
        fetchTimeLockPuzzleVerifyingKey,
        generateTimeLockPuzzleParam,
        generateTimeLockPuzzle,
        generateTimeLockPuzzleProof,
        verifyTimeLockPuzzleProof,
        fetchEncryptionZkpParam,
        fetchEncryptionProvingKey,
        fetchEncryptionVerifyingKey,
        generateSymmetricKey,
        encryptMessage,
        generateEncryptionProof,
        verifyEncryptionProof,
        solveTimeLockPuzzle,
        decryptCipher,
      } = pvde;

      function uint8ArrayToHex(uint8Array) {
        return Array.from(uint8Array, (byte) =>
          byte.toString(16).padStart(2, "0")
        ).join("");
      }

      async function readStream(res) {
        const bytes = await res.arrayBuffer();
        const uint8bytes = new Uint8Array(bytes);
        // const string = uint8ArrayToHex(uint8bytes);
        return uint8bytes;
      }

      // Load time-lock puzzle zkp param and keys
      // Get time-lock puzzle zkp param
      let timeLockPuzzleZkpParam = await fetchTimeLockPuzzleZkpParam();

      // Get time-lock puzzle proving_key
      let timeLockPuzzleZkpProvingKey = await fetchTimeLockPuzzleProvingKey();
      // Get time-lock puzzle verifying key
      let timeLockPuzzleZkpVerifyingKey =
        await fetchTimeLockPuzzleVerifyingKey();

      // 1. Generate time-lock puzzle param
      const timeLockPuzzleParam = await generateTimeLockPuzzleParam();

      // 2. Generate time-lock puzzle
      const timeLockPuzzle = await generateTimeLockPuzzle(timeLockPuzzleParam);

      console.log("timeLockPuzzleParam", timeLockPuzzleParam);
      console.log("timeLockPuzzleZkpParam", timeLockPuzzleZkpParam);
      console.log("timeLockPuzzleZkpProvingKey", timeLockPuzzleZkpProvingKey);
      console.log(
        "timeLockPuzzleZkpVerifyingKey",
        timeLockPuzzleZkpVerifyingKey
      );
      console.log("timeLockPuzzle", timeLockPuzzle);

      const [timeLockPuzzleSecretInput, timeLockPuzzlePublicInput] =
        timeLockPuzzle;

      console.log("timeLockPuzzleSecretInput", timeLockPuzzleSecretInput);
      console.log("timeLockPuzzlePublicInput", timeLockPuzzlePublicInput);

      // 3. Generate zk-proof for the validity of time-lock puzzle
      const timeLockPuzzleProof = await generateTimeLockPuzzleProof(
        timeLockPuzzleZkpParam,
        timeLockPuzzleZkpProvingKey,
        timeLockPuzzlePublicInput,
        timeLockPuzzleSecretInput, // time-lock puzzle secret input
        timeLockPuzzleParam
      );
      console.log("timeLockPuzzleProof", timeLockPuzzleProof);

      // 4. Verify time-lock puzzle proof
      const isTimeLockPuzzleVerified = await verifyTimeLockPuzzleProof(
        timeLockPuzzleZkpParam,
        timeLockPuzzleZkpVerifyingKey,
        timeLockPuzzlePublicInput,
        timeLockPuzzleParam,
        timeLockPuzzleProof
      );

      // Load encryption zkp param and keys
      // Get encryption zkp param
      let encryptionZkpParam = await fetchEncryptionZkpParam();

      // Get encryption proving_key
      let encryptionProvingKey = await fetchEncryptionProvingKey();

      // Get encryption verifying key
      let encryptionVerifyingKey = await fetchEncryptionVerifyingKey();

      const message = "Hello World";

      console.log("encryptionZkpParam", encryptionZkpParam);
      console.log("encryptionProvingKey", encryptionProvingKey);
      console.log("encryptionVerifyingKey", encryptionVerifyingKey);

      // 1. Encryption
      const encryptionKey = await generateSymmetricKey(
        timeLockPuzzleSecretInput.k
      );
      console.log("encryptionKey", encryptionKey);

      const cipher = await encryptMessage(message, encryptionKey);

      console.log("cipher", cipher);

      const encryptionPublicInput = {
        encryptedData: cipher,
        kHashValue: timeLockPuzzlePublicInput.kHashValue,
      };

      console.log("encryptionPublicInput", encryptionPublicInput);

      const encryptionSecretInput = {
        data: message,
        k: timeLockPuzzleSecretInput.k,
      };
      console.log("encryptionSecretInput", encryptionSecretInput);

      // 2. Prove encryption
      const encryptionProof = await generateEncryptionProof(
        encryptionZkpParam,
        encryptionProvingKey,
        encryptionPublicInput,
        encryptionSecretInput
      );

      console.log("encryptionProof", encryptionProof);

      // 3. Verify encryption proof
      const isEncryptionProofVerified = await verifyEncryptionProof(
        encryptionZkpParam,
        encryptionVerifyingKey,
        encryptionPublicInput,
        encryptionProof
      );

      // 4. Get decryption key
      const k = await solveTimeLockPuzzle(
        timeLockPuzzlePublicInput,
        timeLockPuzzleParam
      );

      console.log("k", k);

      const decryptionKey = await generateSymmetricKey(k);

      console.log("decryptionKey", decryptionKey);

      // 5. Decryption
      const decryptedMessage = decryptCipher(cipher, decryptionKey);
    </script>
  </body>
</html>

<!-- 
time-lock puzzle param 
  {
    g: [],
    n:[],
    t: Number,
    y: [],
    yTwo: []
  }

time-lock puzzle zkp param 

    Uint8Array()


time-lock puzzle proving key 

    Uint8Array()

timeLockPuzzle 
  [
    {
      k: []
    },
    {
      kHashValue: [],
      kTwo: [], 
      o: [],
      r1: [], 
      r2: [], 
      z: []
    }
  ]

timeLockPuzzleSecretInput 
  {
    k: []
  }

timeLockPuzzlePublicInput 
  {
    kHashValue: [[],[]]
    kTwo: [], 
    o: [],
    r1: [], 
    r2: [], 
    z: []
  }

timeLockPuzzleProof 
  []

encryptionZkpParam
  []

encryptionProvingKey 
  []

encryptionVerifyingKey 
  []

encryptionKey
 [[],[]]


cipher
  String

encryptionPublicInput 
  {
    encryptedData: String,
    kHashValue: [[],[]]
  }

encryptionSecretInput 

  {
    data: String,
    k: []
  }

encryptionProof 
    []
-->
