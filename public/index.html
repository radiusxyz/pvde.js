<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>PVDE in wasm</title>
  </head>

  <body>
    <script type="module">
      import init, {
        generate_k,
        get_puzzle_param,
        get_puzzle_public_input,
        get_puzzle_proof,
        verify_puzzle_proof,
        solve_puzzle,
      } from "./pkg/pvde.js";

      await init();
      function uint8ArrayToHex(uint8Array) {
        return Array.from(uint8Array, (byte) =>
          byte.toString(16).padStart(2, "0")
        ).join("");
      }

      async function readStream(res) {
        const bytes = await res.arrayBuffer();
        const uint8bytes = new Uint8Array(bytes);
        // const string = uint8ArrayToHex(uint8bytes);
        return uint8bytes;
      }
      // n, g, y_two
      // let timeLockPuzzleParam = await (
      //   await fetch("http://localhost:8000/data/time_lock_puzzle_param.json")
      // ).json();

      // Generate params for making time-lock puzzle
      const puzzle_param = await get_puzzle_param(2048);

      console.log("puzzle_parameters: ", puzzle_param);

      // Generate k (secret input is {k:k}) from n in time-lock puzzle parameters
      const k = generate_k(puzzle_param.n);
      console.log("k: ", k);

      // Destructure time-lock puzzle parameters
      const { g, n, y_two } = puzzle_param;

      // Generate public input for the time-lock puzzle
      const puzzle_public_input = get_puzzle_public_input(k, g, n, y_two);

      console.log("puzzle_public_input: ", puzzle_public_input);

      // Generate zk-proof for the validity of time-lock puzzle
      //// 1. Get zkp param
      let param = await fetch("./data/key_validation_zkp_param.data", {
        method: "GET",
      }).then((res) => readStream(res));

      //// 2. Get proving_key
      let proving_key = await fetch("./data/key_validation_proving_key.data", {
        method: "GET",
      }).then((res) => readStream(res));

      //// 3. Get verifying key
      let verifying_key = await fetch(
        "./data/key_validation_verifying_key.data",
        {
          method: "GET",
        }
      ).then((res) => readStream(res));

      const proof = get_puzzle_proof(
        param,
        proving_key,
        puzzle_public_input,
        { k: k }, // time-lock puzzle secret input
        puzzle_param
      );

      console.log("proof: ", proof);

      console.log("verifying_key: ", verifying_key);

      // Verify zk-proof
      const verified = verify_puzzle_proof(
        param,
        verifying_key,
        puzzle_public_input,
        puzzle_param,
        proof
      );

      console.log("proof verified: ", verified);

      // console.log("proof: ", proof);
      // param: &ParamsKZG<Bn256>,
      // proving_key: &ProvingKey<G1Affine>,
      // time_lock_puzzle_public_input: TimeLockPuzzlePublicInput,
      // time_lock_puzzle_secret_input: TimeLockPuzzleSecretInput,
      // time_lock_puzzle_param: TimeLockPuzzleParam,

      // let response = await fetch('http://localhost:8000/data/key_validation_zkp_param.data')
      // let bytes = await response.arrayBuffer()
      // const paramBytes = new Uint8Array(bytes)

      // const k = generate_k(timeLockPuzzleParam.n);

      // const timeLockPuzzlePublicInput = get_time_lock_puzzle_public_input(k, timeLockPuzzleParam.g, timeLockPuzzleParam.n, timeLockPuzzleParam.y_two);
      // const timeLockPuzzleSecretInput = { k: k };

      // // Proving Key..
      // response = await fetch('http://localhost:8000/data/key_validation_proving_key.data')
      // bytes = response.arrayBuffer()
      // let provingKeyBytes = new Uint8Array(bytes);

      // console.log("paramBytes", paramBytes)
      // console.log("provingKeyBytes", provingKeyBytes)
      // console.log("timeLockPuzzlePublicInput", timeLockPuzzlePublicInput)
      // console.log("timeLockPuzzleSecretInput", timeLockPuzzleSecretInput)
      // console.log("timeLockPuzzleParam", timeLockPuzzleParam)

      // const start = Date.now();
      // let proof = prove_time_lock_puzzle(paramBytes, provingKeyBytes, timeLockPuzzlePublicInput, timeLockPuzzleSecretInput, timeLockPuzzleParam);
      // const end = Date.now();
      // console.log(`Execution time: ${end - start} ms`);
      // console.log(proof);

      // fetch('http://localhost:8000/benches/data/vk_delay_hash_13')
      //   .then((response2) => {
      //     console.log(response2);
      //     response2.arrayBuffer().then(
      //       (bytes2) => {
      //         console.log(bytes2);
      //         let verifying_key_bytes = new Uint8Array(bytes2);
      //         console.log(verifying_key_bytes);
      //         let accept = verify_delay_hash(proof, K_squared, K_hashed, params_bytes, verifying_key_bytes);
      //         console.log("accept: " + accept);
      //       }
      //     )
      //   })

      //       }
      //     )
      //   })
    </script>
  </body>
</html>
