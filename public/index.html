<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>PVDE in wasm</title>
  </head>

  <body>
    <script type="module">
      import init, {
        generate_k,
        get_puzzle,
        get_puzzle_public_input,
        get_puzzle_proof,
        verify_puzzle_proof,
        solve_puzzle,
        calculate_hash,
        encrypt,
        decrypt,
        prove_encryption,
        verify_encryption,
        generate_pubsec_inputs,
        get_key,
      } from "./pkg/pvde.js";

      await init();

      function uint8ArrayToHex(uint8Array) {
        return Array.from(uint8Array, (byte) =>
          byte.toString(16).padStart(2, "0")
        ).join("");
      }

      async function readStream(res) {
        const bytes = await res.arrayBuffer();
        const uint8bytes = new Uint8Array(bytes);
        // const string = uint8ArrayToHex(uint8bytes);
        return uint8bytes;
      }

      // Generate time-lock puzzle
      const puzzle = await get_puzzle(2048);

      console.log("puzzle", puzzle);

      // Destructure time-lock puzzle parameters
      const [puzzle_param, puzzle_secret_input, puzzle_public_input] = puzzle;

      console.log(
        "puzzle_param: ",
        puzzle_param,
        "puzzle_secret_input: ",
        puzzle_secret_input,
        "puzzle_public_input: ",
        puzzle_public_input
      );

      // Generate zk-proof for the validity of time-lock puzzle
      //// 1. Get zkp param
      let param = await fetch("./data/key_validation_zkp_param.data", {
        method: "GET",
      }).then((res) => readStream(res));

      //// 2. Get proving_key
      let proving_key = await fetch("./data/key_validation_proving_key.data", {
        method: "GET",
      }).then((res) => readStream(res));

      //// 3. Get verifying key
      let verifying_key = await fetch(
        "./data/key_validation_verifying_key.data",
        {
          method: "GET",
        }
      ).then((res) => readStream(res));

      const tlp_proof = get_puzzle_proof(
        param,
        proving_key,
        puzzle_public_input,
        puzzle_secret_input, // time-lock puzzle secret input
        puzzle_param
      );

      console.log("proof: ", tlp_proof);

      console.log("verifying_key: ", verifying_key);

      // Verify zk-proof
      const tlp_verified = verify_puzzle_proof(
        param,
        verifying_key,
        puzzle_public_input,
        puzzle_param,
        tlp_proof
      );

      console.log("proof verified: ", tlp_verified);
      const decryption_key = get_key(
        puzzle_param.n,
        2048,
        puzzle_public_input.o
      );
      console.log("decryption key: ", decryption_key);
      console.log(
        "puzzle_param.n: ",
        puzzle_param.n,
        "puzzle_secret_input.k: ",
        puzzle_secret_input.k,
        "puzzle_public_input.k_hash_value: ",
        puzzle_public_input.k_hash_value
      );

      // Encryption
      const hash = await calculate_hash(puzzle_secret_input.k);
      console.log("hash: ", hash);

      const encrypted = encrypt("Hello World", hash);
      console.log("encrypted: ", encrypted);

      const decrypted = decrypt(encrypted, hash);
      console.log("decrypted: ", decrypted);

      // Generate zk-proof for the validity of time-lock puzzle
      //// 1. Get zkp param
      let encryption_zkp_param = await fetch(
        "./data/encryption_zkp_param.data",
        {
          method: "GET",
        }
      ).then((res) => readStream(res));

      //// 2. Get proving_key
      let encryption_proving_key = await fetch(
        "./data/encryption_proving_key.data",
        {
          method: "GET",
        }
      ).then((res) => readStream(res));

      //// 3. Get verifying key
      let encryption_verifying_key = await fetch(
        "./data/encryption_verifying_key.data",
        {
          method: "GET",
        }
      ).then((res) => readStream(res));

      const [encryption_secret_input, encryption_public_input] =
        generate_pubsec_inputs();

      console.log("encryption_secret_input: ", encryption_secret_input);
      console.log("encryption_public_input: ", encryption_public_input);

      const proof = prove_encryption(
        encryption_zkp_param,
        encryption_proving_key,
        encryption_public_input,
        encryption_secret_input
      );

      console.log("encryption proof: ", proof);

      const verified = verify_encryption(
        encryption_zkp_param,
        encryption_verifying_key,
        encryption_public_input,
        proof
      );

      console.log("verified: ", verified);
    </script>
  </body>
</html>
